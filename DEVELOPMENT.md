# Goal

The purpose of this system is to facilitate real-time feedback to EpivizAT users as they configure models. A tighter feedback loop will reduce friction and frustration in the model building process as well as save institute resources by reducing the number of broken jobs that get submitted to the cluster from EpivizAT.

# Overview

The validation service is a very light weight RPC interface to [`cascade.input_data.configuration.form.Configuration()`](https://github.com/ihmeuw/cascade/blob/develop/src/cascade/input_data/configuration/form.py) which is the tool Cascade uses internally to parse and validate EpivizAT's json based parameter documents. It accepts POST requests containing a parameter document encoded as json and responds with a, possibly empty, list of error messages encoded as json.

The intention is that EpivizAT will call the validation service as a gate before creating new model versions or in response to individual edits by users filling out the model wizard. EpivizAT can take each error message generated by the service and display them to the user attached to relevant form elements.

# Performance

Performance is an issue for this service because it is intended to be used in line with user interactions so it must be able to return responses in near real-time. The initial version returns responses in ~10 milliseconds for local requests which should be adequate. As the validations become more complex this may be more of a concern.

# Input Format

The service expects documents in EpivizAT's format as written to the `epi.at_model_parameter` SQL table. There is no formal specification for these documents, see the Cascade [form](https://github.com/ihmeuw/cascade/blob/develop/src/cascade/input_data/configuration/form.py) for details on the expected structure. In general they are a JSON object where each key represents either the value of a field in the GUI, a nested object representing a sub section of the GUI or a list of objects representing a growable list section of the GUI. Inputs should be sent to the service as POST requests where the JSON document is the entire request body.

# Output Format

The response will consist of a JSON document made up of a single list of zero or more two element lists. Each element in the inner list is a string. The first element represents the path to the field in the input which triggered the error and the second element is a human readable description of the error.

The paths consist of field names separated by dots and optionally suffixed with C-style, zero based array index notation. Dots indicate descent into the field name that follows them. If the field name is suffixed with an index then it is expected to be a list and the index indicates which element of the list to descend into. For example, given the following input document:

```
{
  "a" : {
          "b": 10,
          "c": [{"d": 11}, {"d": 12}, {"d": 13}]
        }
}
```

The path "a.b" would indicate the error is associated with the field labeled "b" with the value 10. The path "a.c[1].d" would indicate that the error is associated with the field labeled "d" with the value 12.

# Example Usage

Navigate to [EpivizAT](https://internal.ihme.washington.edu/epi-at/), select a model, click the "Edit model" button and in the edit form click "Download" to download the model configuration as a json document in the format the service expects.

In an environment where the `cascade.validation_service` package is installed launch the flask development server:

```
FLASK_APP=cascade.validation_service FLASK_ENV=development flask run
```

Then POST the model configuration to the service:

```
curl --header "Content-Type: application/json" --request POST -d @/PATH/TO/MODEL_PARAMETERS.json localhost:5000
```

# Future Work

The current setup includes no deployment process or environment in which it can be hosted. Those things would need to be worked out with the EpivizAT team since they have agreed to host this service in the same environment in which they host the EpivizAT application itself.

Some process for pushing updates should also be added, even if that just means redeploying the whole EpivizAT system. Historically the development of EpivizAT and cascade have been loosely coupled but this service introduces a tighter coupling since it includes detailed validations which should match in EpivizAT and in cascade.

Some thought should also go into reliability. As it is, the service is quite simple and should be robust as a result but since it will gate the user's ability to submit models from EpivizAT it must be at least as robust and reliable as EpivizAT iteslf. The current implementation does very little error handling.
